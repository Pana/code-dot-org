# libconfig file format:
# http://www.hyperrealm.com/libconfig/libconfig_manual.html#Configuration-Files

# Variable definitions:
# https://github.com/sysown/proxysql/wiki/Global-variables

datadir="/var/lib/proxysql"
errorlog="/var/lib/proxysql/proxysql.log"

# https://github.com/sysown/proxysql/wiki/Global-variables#admin-variables
admin_variables=
{
  admin_credentials="<%=@admin.user%>:<%=@admin.password%>"
  mysql_ifaces="<%=@admin.host%>:<%=@admin.port%>"
}

# https://github.com/sysown/proxysql/wiki/Global-variables#mysql-variables
mysql_variables=
{
  # The number of background threads that ProxySQL uses in order to process MySQL traffic.
  # https://github.com/sysown/proxysql/wiki/Global-variables#mysql-threads
  threads=<%=node[:cpu][:total]%>

  # Semicolon-separated list of hostname:port entries for interfaces for incoming MySQL traffic.
  # https://github.com/sysown/proxysql/wiki/Global-variables#mysql-interfaces
  interfaces="127.0.0.1:<%= @port %>"

  # The server version with which the proxy will respond to the clients.
  # https://github.com/sysown/proxysql/wiki/Global-variables#mysql-server_version
  server_version="5.7.12-proxysql"

  # The user needs only USAGE privileges to connect, ping and check read_only.
  # The user needs also REPLICATION CLIENT if it needs to monitor replication lag.
  # https://github.com/sysown/proxysql/wiki/Global-variables#mysql-monitor_username
  # https://github.com/sysown/proxysql/wiki/Global-variables#mysql-monitor_password
  monitor_username="<%= @writer.user %>"
  monitor_password="<%= @writer.password %>"
}

# https://github.com/sysown/proxysql/wiki/Main-(runtime)#mysql_servers
mysql_servers =
(
  {
    # the TCP endpoint at which the mysqld instance can be contacted
    address = "<%= @writer.hostname %>"
    port = <%= @writer.port || 3306 %>
    # the hostgroup in which this mysqld instance is included.
    hostgroup = 0
  },
  {
    address = "<%= @reader.hostname %>"
    port = <%= @reader.port || 3306 %>
    hostgroup = 1
  }
)

# https://github.com/sysown/proxysql/wiki/Main-(runtime)#mysql_users
mysql_users:
(
<% if @writer.user != @reader.user -%>
  {
    username = "<%= @reader.user %>"
    password = "<%= @reader.password %>"
    # Send all reader-user queries to reader hostgroup (1) by default.
    default_hostgroup = 1
  },
<% end -%>
  {
    username = "<%= @writer.user %>"
    password = "<%= @writer.password %>"
    default_hostgroup = 0
  }
)

# https://github.com/sysown/proxysql/wiki/Main-(runtime)#mysql_query_rules
mysql_query_rules:
(
  {
    # SELECT .* FOR UPDATE is the one exception to read-write splitting on SELECT,
    # it needs to be sent to writer.
    rule_id=1
    active=1
    match_pattern="^SELECT .* FOR UPDATE$"
    destination_hostgroup=0
    apply=1
  },
  {
    # ar_internal_metadata performs read-after-write from ActiveRecord DB-setup logic.
    # Send all queries on this table to writer.
    rule_id=2
    active=1
    match_pattern="FROM `ar_internal_metadata`"
    destination_hostgroup=0
    apply=1
  },
  {
    # Global read-write split on SELECT, disabled by default (set active=1 to enable).
    rule_id=3
    active=0
    match_pattern="^SELECT"
    destination_hostgroup=1
    apply=1
  },
  {
    # Handle SET command used by application. (Can be removed in 2.0.7+)
    rule_id=4
    active=1
    match_digest="SET SQL_AUTO_IS_NULL"
    multiplex=1
  },
  {
    # Handle SET command used by application. (Can be removed in 2.0.7+)
    rule_id=5
    active=1
    match_digest="SET @@wait_timeout"
    multiplex=1
  },
  {
    # Handle SET command used by application. (Can be removed in 2.0.7+)
    rule_id=6
    active=1
    match_pattern="SET FOREIGN_KEY_CHECKS = (\d+)"
    replace_pattern="SET FOREIGN_KEY_CHECKS=\1"
  },
  {
    # Handle SET command used by application. (Can be removed in 2.0.7+)
    rule_id=7
    active=1
    match_pattern="SET FOREIGN_KEY_CHECKS=\d+"
    multiplex=0
  }
)
